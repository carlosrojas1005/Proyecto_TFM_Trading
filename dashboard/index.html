<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MVP EUR/USD Dashboard (Paper)</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    .kpis {
      display: flex;
      gap: 12px;
    }

    .kpi {
      flex: 1;
      background: #fafafa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .kpi h3 {
      margin: 8px 0 0 0;
      font-size: 24px;
    }

    .kpi div {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }

    .signal-long {
      color: #0a7f42;
      font-weight: bold;
    }

    .signal-short {
      color: #b00020;
      font-weight: bold;
    }

    .signal-neutral {
      color: #666;
    }

    .muted {
      color: #666;
      font-size: 12px;
      line-height: 1.5;
    }

    .llm-box {
      background: #f0f7ff;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }

    h2 {
      margin-top: 0;
    }

    h3 {
      margin-top: 0;
      color: #333;
    }
  </style>
</head>

<body>
  <h2>üìä MVP EUR/USD ‚Äî Paper Trading Dashboard</h2>
  <p class="muted">Esto es √∫nicamente con fines educativos y no constituye asesor√≠a financiera.</p>

  <div class="grid">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <h3 style="margin: 0;">Gr√°fico de Precios con Se√±ales</h3>
        <button id="resetZoom"
          style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          üîç Resetear Zoom
        </button>
      </div>
      <canvas id="priceChart" height="200"></canvas>
      <p class="muted" style="margin-top: 8px; font-size: 11px;">
        üí° <strong>Controles:</strong> Rueda del mouse para zoom | Arrastrar para desplazar (pan) | Click en "Resetear
        Zoom" para volver a la vista original
      </p>
    </div>
    <div class="card">
      <h3>M√©tricas de Performance</h3>
      <div class="kpis">
        <div class="kpi">
          <div>Equity Final</div>
          <h3 id="eqFinal">$‚Äî</h3>
        </div>
        <div class="kpi">
          <div>Max Drawdown</div>
          <h3 id="dd">‚Äî</h3>
        </div>
        <div class="kpi">
          <div>Sharpe</div>
          <h3 id="sharpe">‚Äî</h3>
        </div>
      </div>
      <div class="llm-box">
        <strong>ü§ñ Explicaci√≥n IA (Gemini)</strong>
        <div id="llmText" class="muted" style="margin-top:8px;">Cargando explicaci√≥n...</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Se√±ales de Trading Recientes (√öltimas 50)</h3>
    <table id="signalsTbl">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Precio</th>
          <th>Se√±al</th>
          <th>Confianza</th>
          <th>Stop Loss</th>
          <th>Take Profit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script>
    const API_BASE = "http://127.0.0.1:8000";

    async function fetchJSON(url, fallback) {
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch (e) {
        console.warn("Error fetching", url, e);
        return fallback;
      }
    }

    async function loadMetrics() {
      try {
        const response = await fetch('/backtest_report.json');
        if (response.ok) {
          const data = await response.json();
          return data;
        }
      } catch (e) {
        console.warn("No backtest report found");
      }
      return { metrics: { CAGR: 0.04, Sharpe: 0.16, MaxDrawdown: -0.034 }, last_equity: 10000 };
    }

    function getSignalLabel(signal) {
      if (signal === 1) return '<span class="signal-long">LONG ‚ñ≤</span>';
      if (signal === -1) return '<span class="signal-short">SHORT ‚ñº</span>';
      return '<span class="signal-neutral">‚Äî</span>';
    }

    async function init() {
      // Cargar datos
      const signals = await fetchJSON(`${API_BASE}/signals`, []);
      const metrics = await loadMetrics();

      // Encontrar √∫ltima se√±al activa (long o short)
      const lastSignal = signals.slice().reverse().find(s => s.signal !== 0);

      // Generar explicaci√≥n contextual
      let llmText = "Analizando se√±ales de trading...";
      if (lastSignal) {
        const signalType = lastSignal.signal === 1 ? "LONG (Compra)" : "SHORT (Venta)";
        const signalTime = new Date(lastSignal.timestamp).toLocaleString('es-ES', {
          month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });

        // Obtener explicaci√≥n del LLM
        const expl = await fetchJSON(`${API_BASE}/explanations`, { text: "Procesando an√°lisis..." });

        llmText = `üìç <strong>√öltima se√±al: ${signalType}</strong> (${signalTime})<br>
        <strong>Precio:</strong> ${lastSignal.price.toFixed(5)} | 
        <strong>Confianza:</strong> ${(lastSignal.score * 100).toFixed(0)}%<br>
        <strong>SL:</strong> ${lastSignal.sl ? lastSignal.sl.toFixed(5) : "N/A"} | 
        <strong>TP:</strong> ${lastSignal.tp ? lastSignal.tp.toFixed(5) : "N/A"}<br><br>
        ${expl.text}`;
      } else {
        const expl = await fetchJSON(`${API_BASE}/explanations`, { text: "No hay se√±ales activas en el periodo analizado." });
        llmText = expl.text;
      }

      // Actualizar explicaci√≥n LLM con contexto
      document.getElementById("llmText").innerHTML = llmText;

      // Actualizar KPIs
      if (metrics.last_equity) {
        document.getElementById("eqFinal").innerText = "$" + metrics.last_equity.toFixed(2);
      }
      if (metrics.metrics) {
        document.getElementById("dd").innerText = (metrics.metrics.MaxDrawdown * 100).toFixed(1) + "%";
        document.getElementById("sharpe").innerText = metrics.metrics.Sharpe.toFixed(2);
      }

      // Render tabla de se√±ales (ORDEN INVERSO: m√°s recientes primero)
      const tbody = document.querySelector("#signalsTbl tbody");
      tbody.innerHTML = "";
      const recentSignals = signals.slice(-50).reverse(); // INVERTIR ORDEN
      recentSignals.forEach(s => {
        const tr = document.createElement("tr");
        const time = new Date(s.timestamp).toLocaleString('es-ES', {
          month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        tr.innerHTML = `
      <td>${time}</td>
      <td>${s.price.toFixed(5)}</td>
      <td>${getSignalLabel(s.signal)}</td>
      <td>${(s.score || 0).toFixed(2)}</td>
      <td>${s.sl ? s.sl.toFixed(5) : "‚Äî"}</td>
      <td>${s.tp ? s.tp.toFixed(5) : "‚Äî"}</td>
    `;
        tbody.appendChild(tr);
      });

      // Preparar datos para gr√°fico de velas
      const ctx = document.getElementById("priceChart").getContext("2d");
      const chartData = signals.slice(-100); // √öltimas 100 barras para mejor visualizaci√≥n

      // Crear datos de velas usando datos OHLC reales
      const candlestickData = chartData.map(s => ({
        x: new Date(s.timestamp).getTime(),
        o: s.open,
        h: s.high,
        l: s.low,
        c: s.close
      }));

      // Detectar se√±ales para marcar en el gr√°fico
      const longSignals = chartData.map((s, i) => ({
        x: new Date(s.timestamp).getTime(),
        y: s.signal === 1 ? s.price : null
      })).filter(p => p.y !== null);

      const shortSignals = chartData.map((s, i) => ({
        x: new Date(s.timestamp).getTime(),
        y: s.signal === -1 ? s.price : null
      })).filter(p => p.y !== null);

      const chart = new Chart(ctx, {
        type: "candlestick",
        data: {
          datasets: [
            {
              label: "EUR/USD",
              data: candlestickData,
              color: {
                up: '#26a69a',
                down: '#ef5350',
                unchanged: '#999'
              },
              borderColor: {
                up: '#26a69a',
                down: '#ef5350',
                unchanged: '#999'
              }
            },
            {
              type: 'scatter',
              label: "LONG ‚ñ≤",
              data: longSignals,
              borderColor: "#4CAF50",
              backgroundColor: "#4CAF50",
              pointRadius: 8,
              pointStyle: 'triangle',
              pointRotation: 0
            },
            {
              type: 'scatter',
              label: "SHORT ‚ñº",
              data: shortSignals,
              borderColor: "#F44336",
              backgroundColor: "#F44336",
              pointRadius: 8,
              pointStyle: 'triangle',
              pointRotation: 180
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function (context) {
                  const label = context.dataset.label || '';
                  if (context.parsed.y !== undefined) {
                    return label + ': ' + context.parsed.y.toFixed(5);
                  }
                  return label;
                }
              }
            },
            zoom: {
              zoom: {
                wheel: {
                  enabled: true,
                  speed: 0.1,
                  modifierKey: null  // Permitir zoom sin tecla modificadora
                },
                pinch: {
                  enabled: true
                },
                drag: {
                  enabled: true,
                  backgroundColor: 'rgba(33, 150, 243, 0.1)',
                  borderColor: 'rgba(33, 150, 243, 0.5)',
                  borderWidth: 1
                },
                mode: 'xy'
              },
              pan: {
                enabled: true,
                mode: 'xy',
                modifierKey: null  // Permitir pan sin necesidad de Ctrl
              },
              limits: {
                x: { min: 'original', max: 'original' },
                y: { min: 'original', max: 'original' }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'MMM dd HH:mm'
                }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              }
            },
            y: {
              display: true,
              position: 'right',
              ticks: {
                callback: function (value) {
                  return value.toFixed(5);
                }
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });

      // Bot√≥n para resetear zoom
      document.getElementById('resetZoom').addEventListener('click', function () {
        chart.resetZoom();
      });
    }

    // Recargar cada 30 segundos
    init();
    setInterval(init, 30000);
  </script>
</body>

</html>